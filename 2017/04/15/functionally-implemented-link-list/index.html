<!DOCTYPE html><html lang="en-us"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><title>用函数模拟数据结构 (in Py3) | WHsT</title><meta name="description" content="不用 class/struct，只用函数，实现链表等数据结构以及面向对象式的「成员函数」"><meta name="generator" content="WHsT"><meta name="author" content="Wang Hsü-Tung"><meta name="keywords" content="whst, Wang Hsutung, developer, C/C++, Linux, Vim, Haskell, Scheme"><meta name="HandheldFriendly" content="True"><meta name="MobileOptimized" content="320"><meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1,user-scalable=0"><link rel="stylesheet" type="text/css" href="/styles/screen.css"><link rel="apple-touch-icon" sizes="57x57" href="/images/apple-touch-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/images/apple-touch-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/images/apple-touch-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/images/apple-touch-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/images/apple-touch-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/images/apple-touch-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/images/apple-touch-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/images/apple-touch-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-180x180.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/images/favicon-96x96.png"><link rel="icon" type="image/png" sizes="160x160" href="/images/favicon-160x160.png"><link rel="icon" type="image/png" sizes="192x192" href="/images/favicon-192x192.png"><meta name="msapplication-TileColor" content="#121315"><meta name="msapplication-TileImage" content="/images/mstile-144x144.png"></head><body itemscope itemtype="https://schema.org/WebPage"><header itemscope itemtype="https://schema.org/WPHeader"><a href="/"><img src="/images/whst.png" alt="WHsT" title="WHsT"></a><h1><a href="/" alt="WHsT" title="WHsT" itemprop="headline">WHsT</a></h1><p itemprop="description">WHsT's name is <span itemprop='author' itemscope itemtype='https://schema.org/Person'>Wang Hsü-Tung</span>. <br>Twitter: <a href='https://twitter.com/xukiro' alt='@WANG Hsü-Tung on Twitter' title='@Wang Hsü-Tung'>@xukiro</a>, GitHub: <a href='https://github.com/whst' alt='@WANG Hsü-Tung on GitHub'>whst</a></p><nav itemscope itemtype="https://schema.org/SiteNavigationElement"><ul><li itemprop="name"><a href="/" alt="Home" title="Home" itemprop="url">Home</a></li><li itemprop="name"><a href="/articles" alt="Articles" title="Articles" itemprop="url">Articles</a></li><li itemprop="name"><a href="/inlog" alt="InLog" title="InLog" itemprop="url">InLog</a></li><li itemprop="name"><a href="/about" alt="About" title="About" itemprop="url">About</a></li></ul></nav><div class="space"></div></header><main itemscope itemtype="https://schema.org/Blog"><article class="full"><h1 itemprop="headline">用函数模拟数据结构 (in Py3)</h1><span class="post-meta">Published on<time itemprop="datePublished" datetime="2017-04-15T06:03:48.000Z"> 星期六, 四月 15日 2017 at 14:03</time><br>Last updated on<time itemprop="dateModified" datetime="2017-04-15T06:03:48.000Z"> 星期四, 五月 25日 2017 at 21:54</time></span><blockquote>
<p>Note: 为简便起见，本文中出现的部分概念被简化了。阅读本文你需要会使用 Python</p>
</blockquote>
<p>常见的数据结构，诸如链表、树、图等，都由节点构成。以最简单的链表为例，在 C/C++ 中需要定义类似这样的结构：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> Node &#123;</span><br><span class="line">    T data;</span><br><span class="line">    Node *next;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>由于习惯，很多人可能会潜移默化地认为实现链表必须依赖 class/struct 这样的定义。事实上，在函数是 first-class citizen 的语言中，我们完全可以<strong>只使用函数</strong>来实现这样的结构。不仅如此，甚至可以只使用函数为节点提供「面向对象」风格的操作。</p>
<p>不少语言可以实现这一点。函数式语言自然不用说，这里我们用 Python3 来实现和 Lisp 中类似的表结构。</p>
<p>由于 Python 更多是以 OOP 的方式出现在我们眼前，充分挖掘它的函数式特性也许会颇为 exotic 吧 ;-P</p>
<hr>
<h2 id="0-Lisp-中表的结构"><a href="#0-Lisp-中表的结构" class="headerlink" title="0. Lisp 中表的结构"></a>0. Lisp 中表的结构</h2><p>先科普一下 Lisp 中的表是怎么构成的。<br>在 Lisp 中，cons 函数用于产生一个 pair（类似 Python 的二元组），car 和 cdr 函数分别 用来取出数对的第一和第二个成员。用 Python 语法表示就类似这样：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">p = cons(x, y) # 构造节点 (x, y) 命名为 p</span><br><span class="line">car(p)         # 返回 x</span><br><span class="line">cdr(p)         # 返回 y</span><br></pre></td></tr></table></figure></p>
<p>Lisp 就是用这种「二元组」当成链表的节点来用的，例如表 (1 2 3) 可以这样构成：<code>cons(1, cons(2, (cons(3, None)))</code><br>它在内存中就像这样：</p>
<blockquote>
<p>(1, *)-&gt; (2, *)-&gt; (3, *)-&gt; None</p>
</blockquote>
<p>由于 Lisp 不是纯函数式语言，因此它允许状态的存在，也就是说允许对变量赋值。set-car 函数和 set-cdr 函数分别用来设置一个节点的两个部分指向什么。例如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">p = cons(3, 8) # p is (3, 8)</span><br><span class="line">set_car(p, 4)  # p becomes (4, 8)</span><br><span class="line">set_cdr(p, 9)  # p becomes (4, 9)</span><br></pre></td></tr></table></figure></p>
<h2 id="1-定义-cons-函数！"><a href="#1-定义-cons-函数！" class="headerlink" title="1. 定义 cons 函数！"></a>1. 定义 cons 函数！</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cons</span><span class="params">(x, y)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">set_x</span><span class="params">(v)</span>:</span></span><br><span class="line">        <span class="keyword">nonlocal</span> x</span><br><span class="line">        x = v</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">set_y</span><span class="params">(v)</span>:</span></span><br><span class="line">        <span class="keyword">nonlocal</span> y</span><br><span class="line">        y = v</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">dispatch</span><span class="params">(m)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> m == <span class="string">'car'</span>:</span><br><span class="line">            <span class="keyword">return</span> x</span><br><span class="line">        <span class="keyword">if</span> m == <span class="string">'cdr'</span>:</span><br><span class="line">            <span class="keyword">return</span> y</span><br><span class="line">        <span class="keyword">if</span> m == <span class="string">'set_car'</span>:</span><br><span class="line">            <span class="keyword">return</span> set_x</span><br><span class="line">        <span class="keyword">if</span> m == <span class="string">'set_cdr'</span>:</span><br><span class="line">            <span class="keyword">return</span> set_y</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">"Undefined operation: CONS: "</span> + str(m))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> dispath</span><br></pre></td></tr></table></figure>
<p>在这个实现中，cons 接受两个参数，返回 dispatch 函数。在这种定义之下，假如我们有 <code>n = cons(x, y)</code>，现在 n 实际上是一个函数，那如何把 n 当成一个对象使用呢？</p>
<p>首先我们来看怎么得到传给 cons 的两个参数。dispatch 在接受到 ‘car’ 时返回 x，接受到 ‘cdr’ 时返回 y. 换句话说可以把 <code>n(&#39;car&#39;)</code> 理解成 OOP 常见的形式 <code>n.get_car()</code>，cdr 类似。</p>
<p>而设置成员值稍稍有些不同，dispatch 函数在接收到 ‘set_car’ / ‘set_cdr’ 的时候返回两个函数。我们以 set_x 为例研究：它其实就是一个函数，把参数 v 的值赋给 x 和 y. 但是注意 Python 有个特性：在函数中赋值相默认等同于建立了新的局部变量。因此需要用 <code>nonlocal x</code> 告诉解释器，我们是要改变外层变量 x 的值，而不是建立局部变量 x。不知读者是否注意到了 <code>n(&#39;set_car&#39;)(val)</code> 很像 OOP 中的 <code>n.set_car(val)</code>。</p>
<h2 id="2-添加一些辅助函数！"><a href="#2-添加一些辅助函数！" class="headerlink" title="2. 添加一些辅助函数！"></a>2. 添加一些辅助函数！</h2><p>首先定义几个对于类型判断的小函数。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_null</span><span class="params">(z)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> z == <span class="keyword">None</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_number</span><span class="params">(z)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> isinstance(z, (int, long, float, complex))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_atom</span><span class="params">(z)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> is_number(z) <span class="keyword">or</span> isinstance(z, string)</span><br></pre></td></tr></table></figure>
<p><code>is_null</code> 判断参数是否是 None（等同于 Lisp 中的空表）， <code>is_number</code> 判断参数是否是数，包括整数、长整数、浮点数、复数。<br><code>is_atom</code> 判断参数是否是「原子」。在 Lisp 中，除用 cons 构成的 pair 和空表以外的数据都算原子。这里我们假设所有用到的数据类型只有数、字符串、None、cons 组成的 pair。</p>
<p>另外，虽然上面的「OOP 风格函数」确实工作得很好，Lisp 里却很少采用这种风格。我们还是入乡随俗地将 car 等操作定义成普通函数：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">car</span><span class="params">(z)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> z(<span class="string">'car'</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cdr</span><span class="params">(z)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> z(<span class="string">'cdr'</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">set_car</span><span class="params">(z, new_value)</span>:</span></span><br><span class="line">    z(<span class="string">'set_car'</span>)(new_value)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">set_cdr</span><span class="params">(z, new_value)</span>:</span></span><br><span class="line">    z(<span class="string">'set_cdr'</span>)(new_value)</span><br></pre></td></tr></table></figure></p>
<p>再定义一个生成参数为闭区间内整数的 <code>range</code> 函数。尽管 Python 允许以自定义函数覆盖默认函数，这里我们还是避免这种做法——给列表有关的操作都加上 list 前缀:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">list_range</span><span class="params">(a, b)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> a &gt; b:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">None</span></span><br><span class="line">    <span class="keyword">return</span> cons(a, list_range(a + <span class="number">1</span>, b))</span><br></pre></td></tr></table></figure></p>
<p>以及一个把表转换成可打印字符串的函数：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">list_to_str</span><span class="params">(l)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> is_null(l):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">''</span></span><br><span class="line">    <span class="keyword">return</span> str(car(l)) + <span class="string">' '</span> + list_to_str(cdr(l))</span><br></pre></td></tr></table></figure></p>
<h2 id="3-休息一下-测试一番"><a href="#3-休息一下-测试一番" class="headerlink" title="3. 休息一下 测试一番~"></a>3. 休息一下 测试一番~</h2><p>有了上面这些代码，我们测试一下构建的链表：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Python 3.6.0 (default, Mar  4 2017, 12:32:34) ...</span><br><span class="line">&gt;&gt;&gt; from lisp import *</span><br><span class="line">&gt;&gt;&gt; print(list_to_str(list_range(1, 10)))</span><br><span class="line">1 2 3 4 5 6 7 8 9 10</span><br></pre></td></tr></table></figure></p>
<p>Hooray! It works!</p>
<h2 id="4-折叠、映射与过滤"><a href="#4-折叠、映射与过滤" class="headerlink" title="4. 折叠、映射与过滤"></a>4. 折叠、映射与过滤</h2><p>fold、map、filter 是函数式语言中对可迭代对象的常见的操作，让我们来实现它们。</p>
<p>如果你不清楚什么是 fold 或者 reduce，请查阅资料自行了解这个概念。基本上 Python 的 reduce 函数就相当于左折叠，即 <code>reduce(f, xs, v) &lt;====&gt; fold_l(f, v, xs)</code></p>
<p>由于单链表取头节点很方便，右折叠(fold-right)是最容易实现的：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fold_r</span><span class="params">(f, zero, xs)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> is_null(xs):</span><br><span class="line">        <span class="keyword">return</span> zero</span><br><span class="line">    <span class="keyword">return</span> f(car(xs), fold_r(f, zero, cdr(xs)))</span><br></pre></td></tr></table></figure></p>
<p>利用右折叠我们已经可以实现 map 和 filter：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">list_map</span><span class="params">(proc, xs)</span>:</span></span><br><span class="line">    f = <span class="keyword">lambda</span> x, acc: cons(proc(x), acc)</span><br><span class="line">    <span class="keyword">return</span> fold_r(f, <span class="keyword">None</span>, xs)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">list_filter</span><span class="params">(pred, xs)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">step</span><span class="params">(x, acc)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> cons(x, acc) <span class="keyword">if</span> pred(x) <span class="keyword">else</span> acc</span><br><span class="line">    <span class="keyword">return</span> fold_r(step, <span class="keyword">None</span>, xs)</span><br></pre></td></tr></table></figure></p>
<p>左折叠(fold-left)可以直接用右折叠实现，这种实现方法看上去奇技淫巧：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fold_l</span><span class="params">(f, zero, xs)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">step</span><span class="params">(x, g)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">lambda</span> a: g(f(a, x))</span><br><span class="line">    identity = <span class="keyword">lambda</span> x: x</span><br><span class="line">    <span class="keyword">return</span> fold_r(step, identity, xs)(zero)</span><br></pre></td></tr></table></figure></p>
<p>至于这个巧妙的构造的原理，暂时留给读者思考（如果有时间就更新在博客上给出解释）。</p>
<p>有了 fold，我们可以用一种更简洁的方式实现 <code>list_to_str</code>：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">list_to_str</span><span class="params">(xs)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> fold_r(<span class="keyword">lambda</span> x, acc: str(x) + <span class="string">' '</span> +  acc, <span class="string">''</span>, xs)</span><br></pre></td></tr></table></figure></p>
<h2 id="5-大功告成"><a href="#5-大功告成" class="headerlink" title="5. 大功告成"></a>5. 大功告成</h2><p>测试一下我们写的这几个函数吧：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; from lisp import *</span><br><span class="line">&gt;&gt;&gt; xs = list_range(1, 10)                       # xs = 1,2,3,…,10</span><br><span class="line">&gt;&gt;&gt; list_to_str(list_map(lambda x: x*x, xs))     # 平方数</span><br><span class="line">&apos;1 4 9 16 25 36 49 64 81 100 &apos;</span><br><span class="line">&gt;&gt;&gt; list_to_str(list_filter(lambda x: x%2, xs))  # 奇数</span><br><span class="line">&apos;1 3 5 7 9 &apos;</span><br><span class="line">&gt;&gt;&gt; sub = lambda x, y: x - y</span><br><span class="line">&gt;&gt;&gt; ys = list_range(1, 3) # ys = 1,2,3</span><br><span class="line">&gt;&gt;&gt; fold_l(sub, 0, ys)    # (((0 - 1) - 2) - 3)</span><br><span class="line">-6</span><br><span class="line">&gt;&gt;&gt; fold_r(sub, 0, ys)    # (1 - (2 - (3 - 0)))</span><br><span class="line">2</span><br></pre></td></tr></table></figure></p>
<p>不过有必要说明的是，这种实现只是为了显示「函数的威力」，这里的威力是逻辑上的威力。实际生产环境中当然不可能用这样低效率的代码了。</p>
<p>这里贴上完整代码片段：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#! /usr/bin/env python3</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cons</span><span class="params">(x, y)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">set_x</span><span class="params">(v)</span>:</span></span><br><span class="line">        <span class="keyword">nonlocal</span> x</span><br><span class="line">        x = v</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">set_y</span><span class="params">(v)</span>:</span></span><br><span class="line">        <span class="keyword">nonlocal</span> y</span><br><span class="line">        y = v</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">dispatch</span><span class="params">(m)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> m == <span class="string">'car'</span>:</span><br><span class="line">            <span class="keyword">return</span> x</span><br><span class="line">        <span class="keyword">if</span> m == <span class="string">'cdr'</span>:</span><br><span class="line">            <span class="keyword">return</span> y</span><br><span class="line">        <span class="keyword">if</span> m == <span class="string">'set_car'</span>:</span><br><span class="line">            <span class="keyword">return</span> set_x</span><br><span class="line">        <span class="keyword">if</span> m == <span class="string">'set_cdr'</span>:</span><br><span class="line">            <span class="keyword">return</span> set_y</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">"Undefined operation: CONS: "</span> + str(m))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> dispatch</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">car</span><span class="params">(z)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> z(<span class="string">'car'</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cdr</span><span class="params">(z)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> z(<span class="string">'cdr'</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">set_car</span><span class="params">(z, new_value)</span>:</span></span><br><span class="line">    z(<span class="string">'set_car'</span>)(new_value)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">set_cdr</span><span class="params">(z, new_value)</span>:</span></span><br><span class="line">    z(<span class="string">'set_cdr'</span>)(new_value)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_null</span><span class="params">(z)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> z == <span class="keyword">None</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_number</span><span class="params">(z)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> isinstance(z, (int, long, float, complex))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_atom</span><span class="params">(z)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> is_number(z) <span class="keyword">or</span> isinstance(z, string)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">list_range</span><span class="params">(a, b)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> a &gt; b:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">None</span></span><br><span class="line">    <span class="keyword">return</span> cons(a, list_range(a + <span class="number">1</span>, b))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">list_to_str</span><span class="params">(l)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> is_null(l):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">''</span></span><br><span class="line">    <span class="keyword">return</span> str(car(l)) + <span class="string">' '</span> + list_to_str(cdr(l))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1:2:3:[] --&gt; f(1, f(2, f(3, zero)))</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fold_r</span><span class="params">(f, zero, xs)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> is_null(xs):</span><br><span class="line">        <span class="keyword">return</span> zero</span><br><span class="line">    <span class="keyword">return</span> f(car(xs), fold_r(f, zero, cdr(xs)))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fold_l</span><span class="params">(f, zero, xs)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">step</span><span class="params">(x, g)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">lambda</span> a: g(f(a, x))</span><br><span class="line">    identity = <span class="keyword">lambda</span> x: x</span><br><span class="line">    <span class="keyword">return</span> fold_r(step, identity, xs)(zero)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">list_map</span><span class="params">(proc, xs)</span>:</span></span><br><span class="line">    f = <span class="keyword">lambda</span> x, acc: cons(proc(x), acc)</span><br><span class="line">    <span class="keyword">return</span> fold_r(f, <span class="keyword">None</span>, xs)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">list_filter</span><span class="params">(pred, xs)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">step</span><span class="params">(x, acc)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> cons(x, acc) <span class="keyword">if</span> pred(x) <span class="keyword">else</span> acc</span><br><span class="line">    <span class="keyword">return</span> fold_r(step, <span class="keyword">None</span>, xs)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">list_to_str</span><span class="params">(xs)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> fold_r(<span class="keyword">lambda</span> x, acc: str(x) + <span class="string">' '</span> +  acc, <span class="string">''</span>, xs)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    xs = list_range(<span class="number">1</span>, <span class="number">10</span>)</span><br><span class="line">    print(list_to_str(list_map(<span class="keyword">lambda</span> x: x*x, xs)))     <span class="comment"># Squares</span></span><br><span class="line">    print(list_to_str(list_filter(<span class="keyword">lambda</span> x: x%<span class="number">2</span>, xs)))  <span class="comment"># Odd numbers</span></span><br><span class="line">    sub = <span class="keyword">lambda</span> x,y: x-y</span><br><span class="line">    ys = list_range(<span class="number">1</span>, <span class="number">3</span>)</span><br><span class="line">    print(fold_l(sub, <span class="number">0</span>, ys)) <span class="comment"># (((0 - 1) - 2) - 3)</span></span><br><span class="line">    print(fold_r(sub, <span class="number">0</span>, ys)) <span class="comment"># (1 - (2 - (3 - 0)))</span></span><br></pre></td></tr></table></figure></p>
<p>前面我们的代码为了易于读懂，尽量避免了匿名函数的使用。如果我们全部用匿名函数 + 手动 currying，可以看起来更怪异一点（不过没有 set_car 和 set_cdr，貌似 Python 的匿名函数里无法实现赋值）：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"></span><br><span class="line">cons = <span class="keyword">lambda</span> x: <span class="keyword">lambda</span> y: <span class="keyword">lambda</span> isCar: x <span class="keyword">if</span> isCar <span class="keyword">else</span> y</span><br><span class="line">car = <span class="keyword">lambda</span> node: node(<span class="keyword">True</span>)</span><br><span class="line">cdr = <span class="keyword">lambda</span> node: node(<span class="keyword">False</span>)</span><br><span class="line"></span><br><span class="line">null = <span class="keyword">lambda</span> obj: obj == <span class="keyword">None</span></span><br><span class="line">number = <span class="keyword">lambda</span> obj: isinstance(obj, (int, float, complex))</span><br><span class="line"></span><br><span class="line">id = <span class="keyword">lambda</span> x: x</span><br><span class="line"></span><br><span class="line">foldr = <span class="keyword">lambda</span> f: <span class="keyword">lambda</span> zero: <span class="keyword">lambda</span> xs:\</span><br><span class="line">        zero <span class="keyword">if</span> null(xs) <span class="keyword">else</span> f (car(xs)) (foldr (f) (zero) (cdr(xs)))</span><br><span class="line">foldl = <span class="keyword">lambda</span> f: <span class="keyword">lambda</span> zero: <span class="keyword">lambda</span> xs:\</span><br><span class="line">        foldr (<span class="keyword">lambda</span> x: <span class="keyword">lambda</span> g: <span class="keyword">lambda</span> a: g (f(a)(x))) (id) (xs) (zero)</span><br><span class="line"></span><br><span class="line">display = <span class="keyword">lambda</span> xs: print() <span class="keyword">if</span> null(xs) <span class="keyword">else</span>\</span><br><span class="line">          (print(car(xs), end = <span class="string">' '</span>), display(cdr(xs)))</span><br><span class="line"></span><br><span class="line">map = <span class="keyword">lambda</span> proc: <span class="keyword">lambda</span> xs:\</span><br><span class="line">        foldr (<span class="keyword">lambda</span> x: <span class="keyword">lambda</span> ac: cons(proc(x))(ac)) (<span class="keyword">None</span>) (xs)</span><br><span class="line">filter = <span class="keyword">lambda</span> pred: <span class="keyword">lambda</span> xs:\</span><br><span class="line">         foldr (<span class="keyword">lambda</span> x: <span class="keyword">lambda</span> ac:\</span><br><span class="line">                cons(x)(ac) <span class="keyword">if</span> pred(x) <span class="keyword">else</span> ac) (<span class="keyword">None</span>) (xs)</span><br><span class="line"></span><br><span class="line">range = <span class="keyword">lambda</span> a: <span class="keyword">lambda</span> b: <span class="keyword">None</span> <span class="keyword">if</span> a &gt; b <span class="keyword">else</span> cons(a)(range(a + <span class="number">1</span>)(b))</span><br></pre></td></tr></table></figure></p>
<hr>
<p>说句题外话，Python 确实是一门挺好玩的语言。有很多有趣的 feature，可惜语法有些丑。也难怪有人说 Python 是一种实现得不太好的 Lisp。</p>
</article><section id="comments"><!--多说评论框--><div data-thread-key="post-functionally-implemented-link-list" data-title="用函数模拟数据结构 (in Py3)" data.url="http://whst.github.io/2017/04/15/functionally-implemented-link-list/" class="ds-thread"></div><div id="ds_thread"></div><!--多说评论框 END--><script type="text/javascript"> var duoshuoQuery = {short_name: 'whst'};
 (function() {
     var ds = document.createElement('script');
     ds.type = 'text/javascript';ds.async = true;
     ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
     ds.charset = 'UTF-8';
     (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ds);
 })();</script><noscript>Please enable JavaScript to view the comments.</noscript></section></main></body></html>